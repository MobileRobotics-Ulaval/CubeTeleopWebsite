<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<!-- image streams -->
<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/mjpegcanvasjs/current/mjpegcanvas.min.js"></script>

<!-- Teleop -->
<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>

<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/keyboardteleopjs/current/keyboardteleop.min.js"></script>

<style type="text/css">


#leftDiv{
	width: 650;
	float: left;
	background-color:lightgreen;
} 

#rightDiv{
	overflow-x: scroll;
	width: 50%;
	float: right;
	background-color:lightblue;
}
#url-vlc{
	width: 90%;
}
</style>

<script type="text/javascript" type="text/javascript">

  var NAMES_OF_VIDEO_FEED_TOPIC = ['/mamba/ardrone/image_raw', '/king/ardrone/image_raw'];
  var LABELS_OF_VIDEO_FEED_TOPIC = ['robot front camera', 'robot back camera...'];
  var NAME_OF_POSITION_TOPIC = '/cube_position_js';
  var cmdVel;
  var ros;
  var listener;
  var target_topic = "/";
  var autoupdate_timer;
  /**
   * Setup all visualization elements when the page is loaded. 
   */
  function init() {

	ros = new ROSLIB.Ros({
		//url : 'ws://rail-sim2.cs.wpi.edu:9090'
		url : 'ws://localhost:9090'
	});

	ros.on('connection', function() {
		console.log('Connected to websocket server.');
	});

	ros.on('error', function(error) {
		console.log('Error connecting to websocket server: ', error);
	});

	ros.on('close', function() {
		console.log('Connection to websocket server closed.');
	});

	cmdVel = new ROSLIB.Topic({
		ros : ros,
		name : NAME_OF_POSITION_TOPIC,
		messageType : 'geometry_msgs/Point'
	});

	
	// Create the image multistream viewer.
	var viewer = new MJPEGCANVAS.MultiStreamViewer({
		divID : 'mjpeg',
		host : 'localhost',
		width : 640,
		height : 480,
		topics : NAMES_OF_VIDEO_FEED_TOPIC,
		labels : LABELS_OF_VIDEO_FEED_TOPIC
	});
    
    var url_vlc_fullscreen = location.protocol + "//"  + 
				     location.host + ':8080/stream?topic=' + 
				     NAMES_OF_VIDEO_FEED_TOPIC[0];
    $("#url-vlc").val(url_vlc_fullscreen);
    updateTopicsList();
   
    // Subscribe to the last message of the targeted topic
    // And print it in the box
   setInterval(autoUpdate, 500);
}

/**
 Does actions when the submit button is pressed
**/
function sendPosition() {
       //console.log($( "#X" ).val());
	 var point = new ROSLIB.Message({
		x : parseFloat($( "#X" ).val()),
		y : parseFloat($( "#Y" ).val()),
		z : parseFloat($( "#Z" ).val())
	});
	cmdVel.publish(point);
}

function setTargetTopic(){
	// We fetch the message type with is name
	target_topic = $("#topics").val();
	console.log('Name: ' + target_topic);
	updateTargetTopic();
}

function autoUpdate(){
	// If the target topic is defined and auto update is ON
	if(target_topic != "/" && $("#autoupdate")[0].checked){
		updateTargetTopic();
	}
}

function updateTargetTopic(){
	ros.getTopicType(target_topic, 
		function(type){
			//console.log(type);
			console.log("Update topic message");
			listener = new ROSLIB.Topic({
			    ros : ros,
			    name : target_topic,
			   messageType : type
			  });

			  listener.subscribe(function(message) {
				//We check that it's not an image before converting it to text
				if(type.match("/Image$")){
				$('#topic-out').html("Use the image stream on the left for displaying image");
				}
				else{
				var indentedMsgOutput = JSON.stringify(message, null, 4);
				$('#topic-out').html(indentedMsgOutput);
				}
				listener.unsubscribe();
			  });
	});
}


function updateTopicsList(){
	ros.getTopics(
		function(results) {
			console.log("Refresing topics")
			$("#topics").empty();
				$("#topics").append("<option >/</option>");
			for(var i in results){
				$("#topics").append("<option >" + results[i] + "</option>");
			}
	});
	
}

</script>
</head>

<body onload="init()">
  <h2>Tryphon Teleoperation Interface</h2>
<div id="leftDiv"> 
<form id="position">
	<div>
		<input type="number" id="X" name="X" min="0" step="0.1" value="0.4" />m
		<input type="number" id="Y" name="Y" min="0" step="0.1" value="0.4" />m
		<input type="number" id="Z" name="Z" min="0" step="0.1" value="0.4" />m
		<input type='button' value='Send position' onClick='sendPosition()' >
	</div>
</form>
  <div id="mjpeg"></div>
  URL for VLC in (Media > Open Network Stream...): <input type="text" id="url-vlc" name="url-vlc" />
</div>

<div id="rightDiv"> 
	<input type='button' value='Refresh topics' onClick='updateTopicsList()' /><label>Auto update:</label><input type="checkbox" id="autoupdate" value="0" />
	<select id="topics" onchange="setTargetTopic()"><option>/</option></select> 
	<pre id="topic-out"></pre>
</div>

</body>
</html>


