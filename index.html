<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<!-- image streams -->
<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/mjpegcanvasjs/current/mjpegcanvas.min.js"></script>

<!-- Teleop -->
<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>

<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/keyboardteleopjs/current/keyboardteleop.min.js"></script>

<style type="text/css">


#leftDiv{
	overflow-y: scroll;
	width: 50%;
	height: 400px;
	float: left;
	background-color:lightgreen;
} 

#rightDiv{
	overflow-y: scroll;
	width: 50%;
	height: 400px;
	float: right;
	background-color:lightblue;
}
</style>

<script type="text/javascript" type="text/javascript">

  var NAME_OF_VIDEO_FEED_TOPIC = '/mamba/ardrone/image_raw';
  var NAME_OF_POSITION_TOPIC = '/cube_position_js';
  var cmdVel;
  var ros;
  var listener;
  /**
   * Setup all visualization elements when the page is loaded. 
   */
  function init() {

	ros = new ROSLIB.Ros({
		//url : 'ws://rail-sim2.cs.wpi.edu:9090'
		url : 'ws://localhost:9090'
	});

	ros.on('connection', function() {
		console.log('Connected to websocket server.');
	});

	ros.on('error', function(error) {
		console.log('Error connecting to websocket server: ', error);
	});

	ros.on('close', function() {
		console.log('Connection to websocket server closed.');
	});

	cmdVel = new ROSLIB.Topic({
		ros : ros,
		name : NAME_OF_POSITION_TOPIC,
		messageType : 'geometry_msgs/Point'
	});

	
	// Create the main viewer.
	var viewer = new MJPEGCANVAS.Viewer({
		divID : 'mjpeg',
		host : 'localhost',
		width : 640,
		height : 480,
		topic : NAME_OF_VIDEO_FEED_TOPIC
	});

	/*
	var teleop = new KEYBOARDTELEOP.Teleop({
		ros : ros,
		topic : '/base_controller/command'
	});*/

	// Create a UI slider using JQuery UI.
	/*$('#speed-slider').slider({
		range : 'min',
		min : 0,
		max : 100,
		value : 90,
		slide : function(event, ui) {
			// Change the speed label.
			$('#speed-label').html('Speed: ' + ui.value + '%');
			// Scale the speed.
			teleop.scale = (ui.value / 100.0);
		}
	});*/

    // Set the initial speed .
    /*$('#speed-label').html('Speed: ' + ($('#speed-slider').slider('value')) + '%');
    teleop.scale = ($('#speed-slider').slider('value') / 100.0);*/
    updateTopicsList();
    	
}

/**
 Does actions when the submit button is pressed
**/
function sendPosition() {
       //console.log($( "#X" ).val());
	 var point = new ROSLIB.Message({
		x : parseFloat($( "#X" ).val()),
		y : parseFloat($( "#Y" ).val()),
		z : parseFloat($( "#Z" ).val())
	});
	cmdVel.publish(point);
}

function showTopicOutput(name){
	// We fetch the message type with is name
	ros.getTopicType(name, 
		function(type){
			//console.log(type);
			listener = new ROSLIB.Topic({
			    ros : ros,
			    name : name,
			   messageType : type
			  });

			  listener.subscribe(function(message) {
			    //console.log('Received message on ' + listener.name + ': ' + message);
			    //$('#topic-out').text('Received message on ' + listener.name + ': ' + message);
			    listener.unsubscribe();
			    var indentedMsgOutput = JSON.stringify(message, null, 4);
			    $('#topic-out').html(indentedMsgOutput);
/*'Received message on ' + listener.name + ': <br/ > ' + */
			  });
	}/*, name*/);
}

function updateTopicsList(){
	ros.getTopics(
		function(results) {
			console.log("Refresing topics")
			$("ul").empty();
			for(var i in results){
				$("ul").append("<li><a href=\"#topic-out\" onclick=\"showTopicOutput('" + results[i] + "')\">" + results[i] + "</a></li>");
			}
	});
	
}

</script>
</head>

<body onload="init()">
  <h2>Cube Teleoperation Interface</h2>
<form id="position">
	<div>
		<input type="number" id="X" name="X" min="0" step="0.1" value="0.4">
		<input type="number" id="Y" name="Y" min="0" step="0.1" value="0.4">
		<input type="number" id="Z" name="Z" min="0" step="0.1" value="0.4">
		<input type='button' value='Send position' onClick='sendPosition()' >
	</div>
</form>
  <div id="mjpeg"></div>
<input type='button' value='Refresh topics' onClick='updateTopicsList()' />
  <div id="speed-label"></div>
  <div id="speed-slider"></div>

<div id="rightDiv"> 
  <pre id="topic-out"></pre>
</div>
<div id="leftDiv"> 
<ul> </ul>
</div>

</body>
</html>

